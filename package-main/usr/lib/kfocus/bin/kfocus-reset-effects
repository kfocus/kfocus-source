#!/bin/bash
#
# Copyright 2020-2023 MindShare Inc.
# Written for the Kubuntu Focus by Michael Mikowski and Erich Eickmeyer
#
# Name   : kfocus-reset-effects
# Purpose: Reset KFocus desktop effects and keybindings
# License: GPL v2
# Run by : User
# Spec   : 2169
#
# TODO: Consider adduser.local application on install
# See _configDir below on updates.
#
set -u;

## BEGIN _importCommonFn {
# Summary   : _importCommonFn
# Purpose   : Load common routines, prefer relative dir
# Example   : _importCommonFn;
# Arguments : none
# Globals   : Package vars _baseDir _baseName
# Outputs   : none
# Returns   : none
#
_importCommonFn () {
  declare _lib_list _is_loaded _lib_file;
  _lib_list=(
    "${_baseDir}/lib/common.2.source"
    '/usr/lib/kfocus/lib/common.2.source'
  );
  _is_loaded='n';
  for _lib_file in "${_lib_list[@]}"; do
    if [ -r "${_lib_file}" ]; then
      # shellcheck source=../lib/common.2.source
      if source "${_lib_file}"; then
        _is_loaded='y';
        break;
      fi
    fi
  done

  if [ "${_is_loaded}" = 'n' ]; then
    echo 1>&2 "${_baseName}: ABORT - Cannot source common lib";
    exit 202;
  fi
}
## . END _importCommonFn }

## BEGIN _mainFn {
_mainFn () {
  declare _prompt_msg _model_code _config_list _line _bit_list _key \
    _log_list _name_file _config_file _opt_list _reply_str;

  _prompt_msg="$(cat <<_EOH01
${_cm2HtmBeginStr}
<h3 style="color:#f7941d">RESET KFOCUS DESKTOP UX</h3>

${_cm2HtmPStr}This app resets keyboard shortcuts and desktop<br>
effects to Kubuntu Focus defaults. Please close <br>
<b>System Settings</b> before proceeding.</p>
${_cm2HtmEndStr}
_EOH01
  )";
  _cm2PromptUserFn "${_prompt_msg}" "${_rootTitle}";

  _model_code="$(_cm2EchoModelStrFn 'code')";
  _config_list=(
    # Desktops. Confirmed clearing these then defaults to k5-settings values.
    # Click on Virtual Desktops > [Defaults] does NOT do this correctly.
    'kwin|Desktops|Name_1|'
    'kwin|Desktops|Name_2|'
    'kwin|Desktops|Name_3|'
    'kwin|Desktops|Name_4|'
    'kwin|Desktops|Number|'
    'kwin|Desktops|Rows|'

    # Desktopgrid. Confirmed clearing does NOT work correctly. Reset required.
    # Click on Desktop Effects [Defaults] appears to also works.
    'kwin|Effect-Desktopgrid|BorderActivate|'
    'kwin|Effect-Desktopgrid|ClickBehavior|'
    'kwin|Effect-Desktopgrid|CustomLayoutRows|'
    'kwin|Effect-desktopgrid|DesktopLayoutMode|1'
    'kwin|Effect-desktopgrid|DesktopNameAlignment|36'
    'kwin|Effect-desktopgrid|LayoutMode|1'
    'kwin|Effect-Desktopgrid|PresentWindows|'
    'kwin|Effect-desktopgrid|ShowAddRemove|false'

    # Wobbly and transparent windows
    #   Confirmed clearing does NOT work correctly. Reset required.
    'kwin|Effect-wobblywindows|AdvancedMode|true'
    'kwin|Effect-wobblywindows|Drag|85'
    'kwin|Effect-wobblywindows|Stiffness|10'
    'kwin|Effect-wobblywindows|WobblynessLevel|5'
    'kwin|Effect-kwin4_effect_translucency|MoveResize|80'

    # Magic Lamp
    'kwin|Effect-magiclamp|AnimationDuration|500'

    # Enable plugins
    #   Confirmed clearing does NOT work correctly. Reset required.
    'kwin|Plugins|desktopgridEnabled|true'
    'kwin|Plugins|kwin4_effect_translucencyEnabled|true'
    'kwin|Plugins|mouseclickEnabled|true'
    'kwin|Plugins|trackmouseEnabled|true'
    'kwin|Plugins|wobblywindowsEnabled|true'
    'kwin|Plugins|magiclampEnabled|true'

    # Disable night color by default; it can cause flickering on Intel
    #   Confirmed clearing does NOT work correctly. Reset required.
    'kwin|Compositing|OpenGLIsUnsafe|false'
    'kwin|NightColor|Active|false'

    # Keyboard shortcuts
    'scut|kwin|Switch to Previous Desktop|Meta+Ctrl+Up,,Switch to Previous Desktop'
    'scut|kwin|Switch to Next Desktop|Meta+Ctrl+Down,,Switch to Next Desktop'
    'scut|kwin|Window Fullscreen|Meta+F,,Make Window Fullscreen'
    'scut|kwin|Show Desktop Grid|ShowDesktopGrid=Ctrl+F8,Ctrl+F8,Show Desktop Grid'

    # Setup scale factor based on device and clear old settings.
    #   In Plasma 5.27.x, global scale is preferred, deprecates 3521
    #   Notice we clear *all* values first.
    'font|General|forceFontDPI||'
    'glob|KScreen|ScaleFactor||'

    # 2023-10-22 This no longer appears needed for Plasma 5.27.
    #   The default appears pulled from kf5-settings/kdeglobals
    # 'glob|KScreen|ScaleFactor|1.125|ir14g1'
    # 'glob|KScreen|ScaleFactor|1.375|m2g4'
    # 'glob|KScreen|ScaleFactor|1.375|m2g5'
    # 'glob|KScreen|ScaleFactor|1.375|m2g5p'
  );

  _log_list=();
  for _line in "${_config_list[@]}"; do
    IFS='|' read -r -a _bit_list <<< "${_line}";
    _key="${_bit_list[0]:-}";

    ## DEBUG: Skip keys
    # if [[ "${_key}" =~ ^(font|glob)$ ]]; then _cm2EchoFn "Process ${_line}";
    # else _cm2WarnStrFn "Skip ${_line}"; continue;
    # fi

    # DEBUG Delete all kwin keys
    # if [ "${_key}" = 'kwin' ]; then _bit_list[3]=''; fi

    _name_file="${_fileMap[$_key]}";
    if [ -z "${_name_file}" ]; then
      _log_list+=( "WARN: Config key |${_key}| is not supported." );
      continue;
    fi

    _config_file="${_configDir}/${_name_file}";
    if [ ! -f "${_config_file}" ]; then
      if touch "${_config_file}"; then
        _log_list+=( "NOTICE: Created config file |${_config_file}|." );
      else
        _log_list+=( "ERROR: Could not create config file |${_config_file}|." );
        continue;
      fi
    fi

    if [ -n "${_bit_list[4]:-}" ]; then
      if grep -q "${_model_code}" <<< "${_bit_list[4]:-}"; then
        _log_list+=( "Apply ${_bit_list[*]} for model ${_bit_list[4]:-}" );
      else
        _log_list+=( "SKIP  ${_bit_list[*]} for model ${_bit_list[4]:-}" );
        continue;
      fi
    else
      _log_list+=( "Apply ${_bit_list[*]}" );
    fi

    _opt_list=(
      '--file' "${_config_file}" '--group'
      "${_bit_list[1]}" '--key' "${_bit_list[2]}"
    );

    # DEBUG
    if [ -n "${_bit_list[3]:-}" ]; then
      _opt_list+=("${_bit_list[3]}");
    else
      _opt_list+=('--delete');
    fi

    "${_kwriteconfig5Exe}" "${_opt_list[@]}";
  done

  ( IFS=$'\n'; _cm2EchoFn "Reset values:\n${_log_list[*]}"; )

  _config_file="${_configDir}/powermanagementprofilesrc";

  if [ -f "${_config_file}" ]; then
    _prompt_msg='Reset power management to default';
    _reply_str="$(_cm2PromptUserFn "${_prompt_msg}" "${_rootTitle}" 'a')";
    if [ "${_reply_str}" = 'y' ]; then
      rm "${_config_file}" || true;
    fi
  fi

  _prompt_msg="$(cat <<_EOH02
${_cm2HtmBeginStr}
<h3 style="color:#f7941d">RESET KFOCUS UX COMPLETE</h3>
${_cm2HtmPStr}Please <b>IMMEDIATELY</b> log out and back in<br>
to ensure all defaults are applied.</p>
${_cm2HtmEndStr}
_EOH02
  )";
  _cm2PromptUserFn "${_prompt_msg}" "${_rootTitle}";
}
## . END _mainFn }

## BEGIN Declare and assign global vars {
declare _rootTitle _assignList _kwriteconfig5Exe _configDir;
declare -A _fileMap=(
  ['scut']=kglobalshortcutsrc
  ['font']=kcmfonts
  ['glob']=kdeglobals
  ['kwin']=kwinrc
);
_rootTitle='Kubuntu Focus Reset Effects';
_configDir="$HOME/.config";
# Update the following files with this script before deployment
# _configDir="$HOME/Github/kfocus-source/package-settings/usr/lib/kfocus/skel/.config";
# _configDir="$HOME/Github/kfocus-source/package-settings/usr/share/kfocus/kf5-settings";
## . END Declare and assign global vars }

## BEGIN Run main if script is not sourced {
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  _binName="$(  readlink -f "$0"       )" || exit 101;
  _binDir="$(   dirname  "${_binName}" )" || exit 101;
  _baseDir="$(  dirname  "${_binDir}"  )" || exit 101;
  _baseName="$( basename "${_binName}" )" || exit 101;

  _importCommonFn;

  _assignList=(
    '_kwriteconfig5Exe|kwriteconfig5'
  );
  if ! _cm2AssignExeVarsFn "${_assignList[@]}"; then
    _cm2WarnStrFn 'Could not assign variables';
    exit 1;
  fi
  _mainFn "$@";
fi
## . END Run main if script is not sourced }
